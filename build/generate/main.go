package main

import (
	"context"
	"fmt"
	"log"
	"os"

	"github.com/kellegous/glue/build"
)

func main() {
	pkg := os.Getenv("GOPACKAGE")
	if pkg == "" {
		log.Fatal("GOPACKAGE not set")
	}

	// VCS_INFO can be passed in via the environment
	info := os.Getenv("VCS_INFO")
	var err error

	if info == "" {
		info, err = build.VCSInfoFromGit(context.Background())
		if err != nil {
			log.Fatal(err)
		}
	}

	code := fmt.Sprintf(codeTemplate, pkg, info)
	if err := os.WriteFile("vcs_info.gen.go", []byte(code), 0644); err != nil {
		log.Fatal(err)
	}
}

var codeTemplate = `// Code generated by go generate; DO NOT EDIT.
package %s

import "github.com/kellegous/glue/build"
func init() {
	build.SetVCSInfo(%q)
}
`
